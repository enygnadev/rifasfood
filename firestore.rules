rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rifas: leitura pública. Criação permitida para usuários autenticados (administrators should use server SDK).
    match /rifas/{rifaId} {
      allow read: if true;
      allow create: if request.auth != null; // admin via client or server
      // Updates that change critical state (vendidos, locked) should be done via server (admin SDK)
      allow update: if false;
      allow delete: if request.auth != null && request.auth.token.admin == true;
      // Note: Scheduled queries require a composite index on (status, timerExpiresAt). See firestore.indexes.json
    }

    // Compras: criação permitida apenas por usuários autenticados
    match /compras/{compraId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if false; // updates via server/webhook
    }

    match /historico/{doc} {
      allow read: if true;
    }

    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Config: leitura e escrita apenas para administradores autenticados
    match /config/autoTemplates {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }
  }
}